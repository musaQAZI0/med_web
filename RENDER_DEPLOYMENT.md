# Deploying MedFellow to Render

## Quick Explanation of the Error You Saw

The error message you received means:
- Render detected your app running on port 5000 using Flask's **development server**
- Development servers are NOT safe or performant for production
- Render had to restart to properly configure networking

**Solution**: Use a production WSGI server like **Gunicorn** (now configured)

---

## Prerequisites

1. A [Render account](https://render.com) (free tier available)
2. Your code in a Git repository (GitHub, GitLab, or Bitbucket)
3. Environment variables ready (OpenAI API key, MySQL credentials)

---

## Deployment Steps

### Option 1: Deploy with render.yaml (Recommended)

1. **Push your code to GitHub/GitLab**
   ```bash
   git init
   git add .
   git commit -m "Initial commit for Render deployment"
   git branch -M main
   git remote add origin <your-repo-url>
   git push -u origin main
   ```

2. **Connect to Render**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click **"New +"** → **"Blueprint"**
   - Connect your GitHub/GitLab repository
   - Render will automatically detect `render.yaml`

3. **Set Environment Variables**

   Render will prompt you to set these required variables:

   - `OPENAI_API_KEY` - Your OpenAI API key
   - `MYSQL_PASSWORD` - Your MySQL database password
   - `MYSQL_HOST` - Your MySQL host (if different from default)
   - `SECRET_KEY` - Auto-generated by Render

   Optional variables (already set in render.yaml):
   - `USE_PHP_BRIDGE=True`
   - `PHP_BRIDGE_URL=https://medfellows.app/db_query.php`
   - `MYSQL_PORT=51549`
   - `MYSQL_USER=root`
   - `MYSQL_DATABASE=railway`

4. **Deploy**
   - Click **"Apply"**
   - Render will build and deploy your app
   - Wait 3-5 minutes for deployment

---

### Option 2: Manual Web Service Setup

1. **Create New Web Service**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click **"New +"** → **"Web Service"**
   - Connect your repository
   - Select the repository

2. **Configure Service**
   ```
   Name: medfellow
   Region: Oregon (or closest to you)
   Branch: main
   Root Directory: med_web
   Runtime: Python 3
   Build Command: ./build.sh
   Start Command: gunicorn app:app
   Plan: Free
   ```

3. **Add Environment Variables** (same as Option 1)

4. **Deploy** - Click "Create Web Service"

---

## Important Configuration Details

### Port Binding

Render automatically sets the `PORT` environment variable. Your app must:
- Read from `os.environ.get('PORT')` ✅ (already configured in app.py:456)
- Bind to `0.0.0.0` (all interfaces) ✅ (already configured)

### Production WSGI Server

- **Gunicorn** is now added to `requirements.txt`
- Start command: `gunicorn app:app`
- This replaces Flask's development server

### Build Process

The `build.sh` script:
```bash
#!/usr/bin/env bash
set -o errexit
pip install --upgrade pip
pip install -r requirements.txt
```

---

## Troubleshooting

### "Port already in use" or "Failed to bind"
- Render sets `PORT` automatically - don't hardcode port 5000
- ✅ Already fixed in app.py

### "Module not found" errors
- Check `requirements.txt` has all dependencies
- Ensure `build.sh` is executable: `chmod +x build.sh`

### Database connection issues
- Verify `MYSQL_HOST`, `MYSQL_PASSWORD` are correct
- Check if `USE_PHP_BRIDGE=True` is appropriate
- Test `/health` endpoint after deployment

### Build fails
- Check Render logs for specific error
- Verify all files are committed to Git
- Ensure Python version compatibility

---

## Monitoring Your App

### Health Check Endpoint
Your app has a health check at `/health` (app.py:32-60)

Test it after deployment:
```bash
curl https://your-app-name.onrender.com/health
```

### View Logs
- Go to Render Dashboard → Your Service → "Logs"
- Real-time logging of all requests and errors

### Background Tasks
Your app uses threading for background tasks (explanations, MCQ generation)
- Tasks persist server-side (not in localStorage)
- Check `/running-tasks` endpoint to monitor active tasks

---

## Post-Deployment

1. **Test all endpoints**:
   - `/` - Main page
   - `/health` - Database connection
   - `/fetch-categories` - API test
   - `/questions` - Questions interface

2. **Configure custom domain** (optional):
   - Render Dashboard → Settings → Custom Domain
   - Add your domain and configure DNS

3. **Set up monitoring**:
   - Enable Render's uptime monitoring
   - Set up alerts for downtime

---

## File Structure for Deployment

```
med_web/
├── app.py              # Main Flask app (updated for PORT binding)
├── config.py           # Configuration
├── requirements.txt    # Python dependencies (includes gunicorn)
├── build.sh           # Build script
├── render.yaml        # Render configuration
├── .env.example       # Environment variables template
├── modules/
│   ├── database.py
│   ├── tasks.py
│   └── ...
├── templates/
│   └── ...
└── static/
    └── ...
```

---

## Cost

- **Free tier**: 750 hours/month (sufficient for 1 app running 24/7)
- **Limitations**:
  - App spins down after 15 minutes of inactivity
  - First request after spin-down takes 30-60 seconds
  - 512 MB RAM

- **Paid tier** ($7/month):
  - No spin-down
  - More RAM and CPU
  - Better performance

---

## Next Steps

1. Commit and push all changes
2. Follow Option 1 or Option 2 above
3. Set environment variables in Render
4. Monitor deployment logs
5. Test your deployed app

Your app will be available at: `https://your-app-name.onrender.com`
